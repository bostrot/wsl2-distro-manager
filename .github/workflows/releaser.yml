name: Releaser

on:
  push:
    branches:
      - main
      - actions-fix

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3
      # get version from pubspec.yaml and check if release already exists
      - name: Get version
        id: get_version
        outputs:
          outcome: ${{ steps.get_version.outputs.outcome }}
          version: ${{ steps.get_version.outputs.version }}
        run: |
          $pattern = "version: (.*?) \#"
          $string = Get-Content pubspec.yaml
          $wsl2_manager_version = [regex]::match($string, $pattern).Groups[1].Value
          # Make web REST call to check if release already exists
          $result = $(Invoke-RestMethod -Uri https://api.github.com/repos/bostrot/wsl2-distro-manager/releases/tags/v$wsl2_manager_version)
          if ($result) {
            echo "Release v$wsl2_manager_version already exists."
            echo "outcome=failure" >> $env:GITHUB_OUTPUT
          } else {
            echo "outcome=success" >> $env:GITHUB_OUTPUT
          }
          echo "version=$wsl2_manager_version" >> $env:GITHUB_OUTPUT
      # if get_version step does not fail just build nightly
      - uses: subosito/flutter-action@v2
        if: ${{ steps.get_version.outputs.outcome == 'success' }}
        with:
          channel: 'stable'
      - run: flutter config --enable-windows-desktop
        if: ${{ steps.get_version.outputs.outcome == 'success' }}
      - run: flutter build windows
        if: ${{ steps.get_version.outputs.outcome == 'success' }}
      # create nightly release
      - uses: actions/upload-artifact@v3
        name: Create nightly release
        if: ${{ steps.get_version.outputs.outcome == 'success' }}
        with:
          name: wsl2-distro-manager-v${{ steps.get_version.outputs.version }}-${{ github.run_number }}
          path: |
            ./build/windows/runner/Release/*
            ./windows-dlls/*
      # if get_version step fails build
      - uses: subosito/flutter-action@v2
        if: ${{ steps.get_version.outputs.outcome == 'failure' }}
        with:
          channel: 'stable'
      - run: flutter config --enable-windows-desktop
        if: ${{ steps.get_version.outputs.outcome == 'failure' }}
      - run: flutter build windows
        if: ${{ steps.get_version.outputs.outcome == 'failure' }}
      # create release
      - name: Create release
        if: ${{ steps.get_version.outputs.outcome == 'failure' }}
        run: |
          Copy-Item -Path ./windows-dlls/* -Destination ./build/windows/runner/Release/
          Compress-Archive -Path ./build/windows/runner/Release/* -DestinationPath .\wsl2-distro-manager-v${{ steps.get_version.outputs.version }}.zip
          Write-Output 'gh release create v${{ steps.get_version.outputs.version }} ./build/windows/runner/Release/wsl2-distro-manager-v${{ steps.get_version.outputs.version }}.zip  --generate-notes --notes "This is an automated release."'
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ github.token }}
      